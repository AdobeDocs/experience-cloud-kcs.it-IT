---
title: '“Errore: troppi file aperti”'
description: Descrizione
solution: Experience Manager
product: Experience Manager
applies-to: "Experience Manager"
keywords: “KCS”
resolution: Resolution
internal-notes: null
bug: false
article-created-by: Roxann McGlumphy
article-created-date: "10/20/2021 11:05:19 PM"
article-published-by: Roxann McGlumphy
article-published-date: "10/20/2021 11:10:07 PM"
version-number: 1
article-number: KA-17470
dynamics-url: "https://adobe-ent.crm.dynamics.com/main.aspx?forceUCI=1&pagetype=entityrecord&etn=knowledgearticle&id=dc40aa30-fa31-ec11-b6e5-000d3a5ba97a"
exl-id: 534227cf-df15-4255-b699-e26953bf90e6
source-git-commit: 0c3e421beca46d9fe1952b1f98538a50697216a0
workflow-type: tm+mt
source-wordcount: '641'
ht-degree: 100%

---

# Errore: troppi file aperti

## Descrizione

<br><br><br>Problema<br><br><br><br><br><br>
I file di registro contengono l’errore “Troppi file” e AEM non risponde.
<br><br><br><br><br><br>Causa<br><br><br><br><br><br>
La causa è da attribuirsi a una tra queste due possibilità:

- L’applicazione non riesce a chiudere le risorse, come file o socket, dopo averle utilizzate.
- L’applicazione richiede un numero di file aperti superiore a quello consentito dal processo.



## Risoluzione

<br><br> <br><br><br><br><br><br>
La soluzione a questo problema consiste in:

1. Individuare la causa del raggiungimento del limite di file aperti
2. Aumentare il limite o risolvere i bug dell’applicazione.

<br><br><br><br>Trovare i file o i socket rimasti aperti<br><br> <br><br>
\*\* I limiti relativi ai file aperti si applicano al totale di file, pipe e socket aperti, non solo ai file.

Sulla piattaforma [!DNL Linux] è possibile utilizzare il comando `lsof` per eseguire il debug delle risorse aperte dal processo.

Di seguito è riportato uno script di esempio per raccogliere output `lsof` utili:
<br><br><br><br><br> <br><br><br><br>

```
#!/bin/bash` `if` `$` `# -eq 0` `  ` `then` `    ` `echo` `"No PID specified"` `    ` `echo` `"Run command with PID, for example:"` `    ` `echo` `"lsof-script.sh 12345"` `    ` `exit` `2` `fi`<br>   <br>  `JAVA_PROCESS_PID=$1`<br>   <br>  `lsof` `-p $JAVA_PROCESS_PID` `lsof` `-output-$JAVA_PROCESS_PID.txt`<br>   <br>  `echo` `"Files open by the process:"` `cat` `lsof` `-output-$JAVA_PROCESS_PID.txt | ` `wc` `-l`<br>   <br>  `echo` `"Generated output file with counts of grouped open files lsof-sorted-counts-$JAVA_PROCESS_PID.txt"` `cat` `lsof` `-output-$JAVA_PROCESS_PID.txt |` `awk` `'{print $9}'` `|` `sed` `-e` `"s/\(.*\)\(segmentstore\).*$/\1\2/"` `| ` `sed` `-e` `"s/\(.*\)\(repository/index\).*$/\1\2/"` `|` `sed` `-e` `"s/\(.*\)\(felix/bundle\).*$/\1\2/"` `| ` `sed` `-e` `"s/\(.*\)\(/lib\).*$/\1\2/"` `| ` `sed` `-e` `"s/\(.*\)\(/logs\).*$/\1\2/"` `| ` `sed` `-e` `"s/\(.*\)\(/ext\).*$/\1\2/"` `|` `sort` `|` `uniq` `-c |` `sort` `-rn -k1` `lsof` `-sorted-counts-$JAVA_PROCESS_PID.txt`<br>   <br>  `echo` `"Total open files in OS:"` `lsof` `|` `wc` `-l` 
```


<br><br><br><br><br> <br><br>
Output di esempio:
<br><br><br><br><br> <br><br><br><br>

```
 $ ./lsof-script.sh 18070 Files open by the process:      1995 Generated output file with counts of grouped open files: lsof-sorted-counts-18070.txt Total open files in OS:     18399 
```

<br><br><br><br><br> <br><br>
Esamina l’output del file `lsof-sorted-counts-\*.txt` generato.  Mostra quali file o socket sono attualmente aperti dal processo.

Se nell’elenco sono presenti socket o file che dovrebbero risultare chiusi, è probabile che ciò sia dovuto a un bug dell’applicazione.  Aggiorna il codice dell’applicazione per chiudere i file e i socket dopo averli utilizzati.

Una causa comune della presenza di socket aperti residui è il codice personalizzato che genera il servizio web.  In molti casi vengono utilizzate librerie come [!DNL Apache] [!DNL Commons HttpClient] ma le connessioni non vengono mai chiuse dagli sviluppatori.  Consulta [questo articolo](https://stackoverflow.com/questions/43454514/proper-usage-of-apache-httpclient-and-when-to-close-it) per informazioni dettagliate su [!DNL Apache] [!DNL Commons HttpClient].
<br><br><br><br> <br><br>Aumentare il limite per la sessione della shell<br><br><br><br> <br><br>
Verifica il limite dell’utente per il numero massimo di file aperti, quindi esegui il comando seguente in qualità di utente che esegue il processo AEM:

`ulimit -Sn ulimit -Hn`

Quando utilizzi lo script di avvio predefinito di AEM/CQ, effettua le operazioni seguenti per aumentare il limite:

1. Apri `crx-quickstart/bin/start` per la modifica
2. Aggiungi la variabile `CQ_MAX_OPEN_FILES` nella parte superiore dello script: `CQ_MAX_OPEN_FILES=8192 export CQ_MAX_OPEN_FILES`


Se all’avvio di AEM visualizzi l’errore `-bash: ulimit: open files: cannot modify limit: Operation not permitted`, la configurazione precedente non funziona.

È quindi necessario aumentare il limite in `/etc/security/limits.conf`. Per maggiori dettagli su come riconfigurare il limite dell’utente, vedi di seguito.

Se utilizzi un server applicazioni di terze parti, ad esempio [!DNL JBoss] o [!DNL Websphere], consulta le sezioni seguenti e verifica la documentazione del fornitore.

Nota:

Se nessuna delle configurazioni descritte in questo articolo è in grado di risolvere il problema, verifica i file aperti tramite il comando `lsof -p`. (`-p` è l’ID processo del processo problematico). È possibile che l’applicazione lasci aperti gli handle di file. Se noti che gli handle sono tenuti aperti principalmente da AEM e non dalla tua applicazione, contatta il supporto.


<br><br><br><br> <br><br>Aumentare i limiti dell’utente<br><br><br><br> <br><br>
Per cambiare il numero massimo di file aperti per gli utenti non root, modifica il file `/etc/security/limits.conf`. Puoi impostare il limite per ogni utente:

`crx_process_username soft nofile 8092`

`crx_process_username hard nofile 20000`

Nota:

Questa configurazione diventerà effettiva solo al successivo accesso dell’utente.


<br><br><br><br> <br><br>Aumentare il limite del sistema<br><br><br><br> <br><br>
Talvolta il limite dell’utente è sufficientemente alto, ma il sistema ha raggiunto il numero massimo di file. Esegui la procedura seguente come utente `su/root`:

1. Controlla l’impostazione massima dei file aperti sul sistema operativo (se è inferiore a 20.000, è opportuno aumentarla): `cat /proc/sys/fs/file-max`
2. Aggiungi questa riga a `/etc/sysctl.conf` per aumentare il valore massimo dei file aperti nel sistema: `fs.file-max = 300000`
3. Esegui questo comando: `sysctl -p`
4. Verifica che il nuovo valore venga visualizzato quando esegui questo comando: `cat /proc/sys/fs/file-max`


Nota:

Questa configurazione diventerà effettiva solo al successivo accesso dell’utente.


<br><br><br><br> <br><br>Informazioni aggiuntive<br><br><br><br> <br><br>
Questo errore si verifica quando il sistema o l’utente utilizza il numero massimo di handle di file.

SCARICA
[Recupera il file](https://helpx.adobe.com/content/dam/help/en/experience-manager/kb/TooManyOpenFiles/jcr:content/main-pars/kb_download/check_open_files.sh "check_open_files.sh") <br><br>Script della shell che è possibile utilizzare per monitorare l’utilizzo dei file aperti. Usa questo script solo se l’errore “Troppi file aperti” persiste anche dopo aver aumentato il numero massimo di file. In alternativa, puoi usarlo se sospetti che CRX o l’applicazione stia lasciando aperti gli handle di file. Prima di utilizzare lo script, configura le variabili seguenti: `JAVA_HOME`, `QUICKSTART_PATH`, `OUTPUT_DIR`, `USER`, `MAX_FILES_THRESHOLD`. Per utilizzare lo script, configuralo come un processo cron.
