---
title: "Errore: Troppi file aperti | AEM"
description: Descrizione
solution: Experience Manager
product: Experience Manager
applies-to: "Experience Manager"
keywords: "KCS, errore AEM, troppi file"
resolution: Resolution
internal-notes: null
bug: false
article-created-by: Nayanika Chakravarty
article-created-date: "5/10/2023 7:39:28 PM"
article-published-by: Nayanika Chakravarty
article-published-date: "5/10/2023 8:41:24 PM"
version-number: 5
article-number: KA-17470
dynamics-url: "https://adobe-ent.crm.dynamics.com/main.aspx?forceUCI=1&pagetype=entityrecord&etn=knowledgearticle&id=d9420f5d-6aef-ed11-8849-6045bd006239"
source-git-commit: 1e2cbeeed34575beac152beecf5a332b3a9fd3e6
workflow-type: tm+mt
source-wordcount: '672'
ht-degree: 49%

---

# Errore: Troppi file aperti | AEM

## Descrizione {#description}

<b>Ambiente</b>
Adobe Experience Manager


<b>Problema/Sintomi</b>
I file di registro contengono l&#39;errore &quot;*Troppi file* e Adobe Experience Manager (AEM) non risponde.




## Risoluzione {#resolution}


La soluzione a questo problema consiste in:

1. Individuare la causa del raggiungimento del limite di file aperti
2. Aumentare il limite o risolvere i bug dell’applicazione.


<b>A. Trova quali file o socket rimangono aperti</b>

Nota: i limiti dei file aperti si applicano ai file aperti, ai tubi e alle prese combinati totali, non solo ai file.

Su piattaforma Linux, la <b>Elenco dei file aperti</b> (`lsof`Il comando ) può essere utilizzato per eseguire il debug delle risorse aperte dal processo.

Di seguito è riportato uno script di esempio per raccogliere output `lsof` utili:


```
#!/bin/bash
if `[`  $# -eq 0 `]` 
  then
    echo "No PID specified"
    echo "Run command with PID, for example:"
    echo "lsof-script.sh 12345"
    exit 2
fi
 
JAVA_PROCESS_PID=$1
 
lsof -p $JAVA_PROCESS_PID `>`  lsof-output-$JAVA_PROCESS_PID.txt
 
echo "Files open by the process:"
cat lsof-output-$JAVA_PROCESS_PID.txt |  wc -l
 
echo "Generated output file with counts of grouped open files lsof-sorted-counts-$JAVA_PROCESS_PID.txt"
cat lsof-output-$JAVA_PROCESS_PID.txt | awk '{print $9}' | sed -e "s/\(.*\)\(segmentstore\).*$/\1\2/" |  sed -e "s/\(.*\)\(repository`[` /`]` index\).*$/\1\2/" | sed -e "s/\(.*\)\(felix`[` /`]` bundle\).*$/\1\2/" |  sed -e "s/\(.*\)\(`[` /`]` lib\).*$/\1\2/" |  sed -e "s/\(.*\)\(`[` /`]` logs\).*$/\1\2/" |  sed -e "s/\(.*\)\(`[` /`]` ext\).*$/\1\2/" | sort | uniq -c | sort -rn -k1 `>`  lsof-sorted-counts-$JAVA_PROCESS_PID.txt
 
echo "Total open files in OS:"
lsof | wc -l
```


<u>Output di esempio</u>:


```
$`>`  ./lsof-script.sh 18070
Files open by the process:
    1995
Generated output file with counts of grouped open files: lsof-sorted-counts-18070.txt
Total open files in OS:
   18399
```


Esamina l’output del file `lsof-sorted-counts-*.txt` generato.  Mostra quali file o socket sono attualmente aperti dal processo.

Se trovi i socket aperti o i file elencati che non dovrebbero ancora essere aperti, è probabile che sia dovuto a un bug dell&#39;applicazione. Aggiorna il codice dell’applicazione per chiudere i file e i socket dopo averli utilizzati.

Una causa comune della presenza di socket aperti residui è il codice personalizzato che genera il servizio web. In molti casi, librerie come Apache Commons `HttpClient` vengono utilizzati ma le connessioni non vengono mai chiuse dagli sviluppatori. Vedi [articolo](https://stackoverflow.com/questions/43454514/proper-usage-of-apache-httpclient-and-when-to-close-it) per maggiori dettagli su Apache Commons `HttpClient`.

<b>B. Aumenta il limite per la sessione della shell</b>

Controlla il limite dell&#39;utente per il numero massimo di file aperti, quindi esegui quanto segue come lo stesso utente che AEM processo viene eseguito come:

`ulimit -Sn ulimit -Hn`

Quando utilizzi lo script di avvio predefinito di AEM/CQ, effettua le operazioni seguenti per aumentare il limite:

1. Apri `crx-quickstart/bin/start` per la modifica
2. Aggiungi la variabile `CQ_MAX_OPEN_FILES` nella parte superiore dello script: `CQ_MAX_OPEN_FILES=8192 export CQ_MAX_OPEN_FILES`


Se all’avvio di AEM visualizzi l’errore `-bash: ulimit: open files: cannot modify limit: Operation not permitted`, la configurazione precedente non funziona.

È quindi necessario aumentare il limite in `/etc/security/limits.conf`. Per maggiori dettagli su come riconfigurare il limite dell’utente, vedi di seguito.

Se utilizzi un server applicazioni di terze parti come JBoss o Websphere, segui le sezioni seguenti e verifica con la documentazione del fornitore.

Nota: Se nessuna delle configurazioni di questo articolo risolve il problema, vedi quali file sono aperti utilizzando il comando `lsof -p` (-p è l&#39;id del processo problematico). È possibile che l’applicazione lasci aperti gli handle di file. Se noti che gli handle sono tenuti aperti principalmente da AEM e non dalla tua applicazione, contatta il supporto.

<b>C. Aumentare i limiti dell&#39;utente</b>

Per modificare il numero massimo di file aperti per gli utenti non root, modificare il `file/etc/security/limits.conf`. Puoi impostare il limite per ogni utente:

`crx_process_username soft nofile 8092`

`crx_process_username hard nofile 20000`

Nota: Questa configurazione diventerà effettiva solo al successivo accesso dell’utente.

<b>D. Aumentare il limite del sistema</b>

A volte, il limite utente è abbastanza alto, ma il sistema stesso ha raggiunto il suo numero massimo di file. Esegui quanto segue come utente su/root:

1. Controlla l’impostazione massima dei file aperti sul sistema operativo (se è inferiore a 20.000, è opportuno aumentarla): 
   `cat /proc/sys/fs/file-max`
2. Aggiungi questa riga a /etc/sysctl.conf per aumentare il valore massimo del file aperto del sistema:
   `fs.file-max = 300000`
3. Esegui questo comando:
   `sysctl -p`
4. Verifica che il nuovo valore venga visualizzato quando esegui questo comando: 
   `cat /proc/sys/fs/file-max`


Nota: Questa configurazione ha effetto solo al successivo accesso dell&#39;utente.

<b>Causa</b>

La causa è una delle due possibilità:

- L’applicazione non riesce a chiudere le risorse, come file o socket, dopo averle utilizzate.
- L’applicazione richiede un numero di file aperti superiore a quello consentito dal processo.


<b>Informazioni aggiuntive</b>

Questo errore si verifica quando il sistema o l&#39;utente sta utilizzando i relativi handle di file con numero massimo.

SCARICA

[Recupera il file](https://helpx.adobe.com/experience-manager/kb/CQ55MonitoringTooManyOpenFiles/jcr:content/main-pars/download-section/download-1/file.res/disable-monitoring-scripts-1.0.zip "check_open_files.sh")

Script shell che è possibile utilizzare per monitorare l’utilizzo del file aperto. Usa questo script solo se l’errore “Troppi file aperti” persiste anche dopo aver aumentato il numero massimo di file. In alternativa, puoi usarlo se sospetti che CRX o l’applicazione stia lasciando aperti gli handle di file. Prima di utilizzare lo script, configura le variabili seguenti: `JAVA_HOME`, `QUICKSTART_PATH`, `OUTPUT_DIR`, `USER`, `MAX_FILES_THRESHOLD`. Per utilizzare lo script, configuralo come un processo cron.
