---
title: "SegmentNotFoundException e IllegalArgumentException"
description: Descrizione
solution: Experience Manager
product: Experience Manager
applies-to: "Experience Manager"
keywords: "KCS, Adobe Experience Manager, risoluzione dei problemi, SegmentNotFoundException, IllegalArgumentException, compattazione offline"
resolution: Resolution
internal-notes: "Helpx Link: https://helpx.adobe.com/experience-manager/kb/offline-compaction-fails-with-SegmentNotFoundException-and-IllegalArgumentException.html"
bug: false
article-created-by: Garrett Hartley
article-created-date: "4/22/2022 10:07:10 PM"
article-published-by: Jim Menn
article-published-date: "10/25/2022 2:30:22 AM"
version-number: 8
article-number: KA-16457
dynamics-url: "https://adobe-ent.crm.dynamics.com/main.aspx?forceUCI=1&pagetype=entityrecord&etn=knowledgearticle&id=62bbbe8d-88c2-ec11-983e-0022480ab970"
source-git-commit: 95d98ab8a7715b0fd9920e0dd088219e6a2f3f20
workflow-type: tm+mt
source-wordcount: '957'
ht-degree: 0%

---

# SegmentNotFoundException e IllegalArgumentException

## Descrizione


<b>Ambiente</b>
Adobe Experience Manager

<b>Problema</b>

<u><b>Scenario 1</b></u>
L&#39;esecuzione di una compattazione offline può non riuscire con *SegmentNotFoundException* in caso di problemi di integrità dell’archivio.

Osserva *SegmentNotFoundException* nei file di registro AEM e AEM non funziona come previsto.

<u><b>Scenario 2</b></u>

L&#39;esecuzione di una compattazione offline può non riuscire con *SegmentNotFoundException* in caso di problemi di integrità dell’archivio.

Una traccia di stack simile a quella riportata di seguito viene mostrata nei registri:


```
13:51:21.523 main ERROR o.a.j.o.p.segment.SegmentTracker - Segment not found: 4d139bc4-150c-4f0a-b82a-40a4e519fe8a. Creation date delta is 4 ms.
org.apache.jackrabbit.oak.plugins.segment.SegmentNotFoundException: Segment 4d139bc4-150c-4f0a-b82a-40a4e519fe8a not found
at org.apache.jackrabbit.oak.plugins.segment.file.FileStore.readSegment(FileStore.java:855) oak-run-1.0.22.jar:1.0.22
at org.apache.jackrabbit.oak.plugins.segment.SegmentTracker.getSegment(SegmentTracker.java:134)  oak-run-1.0.22.jar:1.0.22
at org.apache.jackrabbit.oak.plugins.segment.SegmentId.getSegment(SegmentId.java:101) oak-run-1.0.22.jar:1.0.22
...
Exception in thread "main" org.apache.jackrabbit.oak.plugins.segment.SegmentNotFoundException: Segment 4d139bc4-150c-4f0a-b82a-40a4e519fe8a not found
at org.apache.jackrabbit.oak.plugins.segment.file.FileStore.readSegment(FileStore.java:855)
at org.apache.jackrabbit.oak.plugins.segment.SegmentTracker.getSegment(SegmentTracker.java:134)
at org.apache.jackrabbit.oak.plugins.segment.SegmentId.getSegment(SegmentId.java:101)
...
```


<u><b>Scenario 3</b></u>

L&#39;esecuzione di una compattazione offline può non riuscire con *IllegalArgument* Eccezione in caso di problemi di integrità dell’archivio.

Una traccia di stack simile a quella riportata di seguito viene mostrata nei registri:


| `java.lang.IllegalArgumentException`<br><br>`at com.google.common.base.Preconditions.checkArgument(Preconditions.java:77)`<br><br>`at org.apache.jackrabbit.oak.plugins.segment.ListRecord.(ListRecord.java:41)`<br><br>`at org.apache.jackrabbit.oak.plugins.segment.ListRecord.getEntry(ListRecord.java:64)`<br><br>`at org.apache.jackrabbit.oak.plugins.segment.ListRecord.getEntries(ListRecord.java:81)`<br><br>`at org.apache.jackrabbit.oak.plugins.segment.SegmentStream.` `read` `(SegmentStream.java:153)`<br><br>`at org.apache.jackrabbit.oak.commons.IOUtils.readFully(IOUtils.java:53)`<br><br>`at org.apache.jackrabbit.oak.plugins.segment.Compactor.getBlobKey(Compactor.java:412)`<br><br>`at org.apache.jackrabbit.oak.plugins.segment.Compactor.compact(Compactor.java:362)`<br><br>`at org.apache.jackrabbit.oak.plugins.segment.Compactor.compact(Compactor.java:321)`<br><br>`at org.apache.jackrabbit.oak.plugins.segment.Compactor.access$500(Compactor.java:54)`<br><br>`at org.apache.jackrabbit.oak.plugins.segment.Compactor$CompactDiff.propertyAdded(Compactor.java:227)`<br><br>`at org.apache.jackrabbit.oak.plugins.segment.CancelableDiff.propertyAdded(CancelableDiff.java:47)`<br><br>`at org.apache.jackrabbit.oak.plugins.memory.EmptyNodeState.compareAgainstEmptyState(EmptyNodeState.java:156)`<br><br>`at org.apache.jackrabbit.oak.plugins.segment.SegmentNodeState.compareAgainstBaseState(SegmentNodeState.java:434)`<br><br>`at org.apache.jackrabbit.oak.plugins.segment.Compactor$CompactDiff.` `diff` `(Compactor.java:214)`<br><br>`at org.apache.jackrabbit.oak.plugins.segment.Compactor$CompactDiff.childNodeAdded(Compactor.java:263)`<br><br>`at org.apache.jackrabbit.oak.plugins.segment.CancelableDiff.childNodeAdded(CancelableDiff.java:74)`<br><br>`at org.apache.jackrabbit.oak.plugins.memory.EmptyNodeState.compareAgainstEmptyState(EmptyNodeState.java:161)`<br><br>`at org.apache.jackrabbit.oak.plugins.segment.SegmentNodeState.compareAgainstBaseState(SegmentNodeState.java:434)`<br><br>`at org.apache.jackrabbit.oak.plugins.segment.Compactor$CompactDiff.` `diff` `(Compactor.java:214)`<br><br>`at org.apache.jackrabbit.oak.plugins.segment.Compactor$CompactDiff.childNodeAdded(Compactor.java:263)`<br><br>`at org.apache.jackrabbit.oak.plugins.segment.CancelableDiff.childNodeAdded(CancelableDiff.java:74)`<br><br>`at org.apache.jackrabbit.oak.plugins.memory.EmptyNodeState.compareAgainstEmptyState(EmptyNodeState.java:161)`<br><br>`at org.apache.jackrabbit.oak.plugins.segment.SegmentNodeState.compareAgainstBaseState(SegmentNodeState.java:434)`<br><br>`at org.apache.jackrabbit.oak.plugins.segment.Compactor$CompactDiff.` `diff` `(Compactor.java:214)`<br><br>`at org.apache.jackrabbit.oak.plugins.segment.Compactor$CompactDiff.childNodeAdded(Compactor.java:263)`<br><br>`at org.apache.jackrabbit.oak.plugins.segment.CancelableDiff.childNodeAdded(CancelableDiff.java:74)`<br><br>`at org.apache.jackrabbit.oak.plugins.memory.EmptyNodeState.compareAgainstEmptyState(EmptyNodeState.java:161)`<br><br>`at org.apache.jackrabbit.oak.plugins.segment.SegmentNodeState.compareAgainstBaseState(SegmentNodeState.java:434)`<br><br>`at org.apache.jackrabbit.oak.plugins.segment.Compactor$CompactDiff.` `diff` `(Compactor.java:214)`<br><br>`at org.apache.jackrabbit.oak.plugins.segment.Compactor$CompactDiff.childNodeAdded(Compactor.java:263)`<br><br>`at org.apache.jackrabbit.oak.plugins.segment.CancelableDiff.childNodeAdded(CancelableDiff.java:74)` |
| --- |


<b>Causa</b>

A *SegmentNotFoundException* viene restituito quando un segmento non è presente mentre la compattazione tenta di leggere il nodo.
Ci possono essere diverse cause principali per questo:

1. Il segmento è stato rimosso con un intervento manuale (ad esempio: `rm -rf /`).
2. Il segmento è stato rimosso dalla revisione della raccolta degli oggetti inattivi.
3. Impossibile trovare il segmento a causa di un bug nel codice.


Nel caso in cui il problema sia causato dalla revisione della raccolta degli oggetti inattivi (Causa n. 2), <b>assicurati che la compattazione online sia disabilitata </b>per evitare che altri nodi vengano danneggiati.


## Risoluzione


<b>Soluzione</b>

Possiamo seguire più procedure per risolvere la situazione e completare con successo la Compattazione Offline.

*Importante:* Esegui un backup completo del tuo archivio prima di seguire i passaggi seguenti.



<b>A. Torna all&#39;ultima revisione valida nota dell&#39;archivio segmenti.</b>

La modalità di esecuzione del controllo di oak-run può essere utilizzata per determinare l&#39;ultima revisione valida nota di un archivio segmenti.
Può essere utilizzato per ripristinare manualmente un archivio di segmenti corrotti alla sua ultima revisione valida.

*Attenzione:<b>* </b>Questo processo consente di ripristinare i dati del sistema in un momento precedente.
Se desideri evitare di perdere le modifiche nel sistema, puoi provare <b>Opzione B</b> invece.

Per eseguire il controllo e il ripristino, effettua le seguenti operazioni:

1. Scarica la `oak-run` file jar da qui [https://repo1.maven.org/maven2/org/apache/jackrabbit/oak-run/](https://repo1.maven.org/maven2/org/apache/jackrabbit/oak-run/)
2. AEM.
3. Esegui questo comando:

   `java -jar oak-run-*.jar check --bin=-1 crx-quickstart/repository/segmentstore/`



   Questo comando esegue una ricerca all&#39;indietro attraverso le revisioni fino a quando non ne trova una coerente:



   `14:00:30.783 main INFO  o.a.j.o.p.s.f.t.ConsistencyChecker - Found latest good revision afdb922d-ba53-4a1b-aa1b-1cb044b535cf:234880`



   (In caso di errore di ConsistencyChecker, passare alla sezione successiva)


4. Ripristina l&#39;archivio a questa revisione modificando:



   `/crx-quickstart/repository/segmentstore/journal.log`



   Elimina tutte le righe dopo la riga contenente l&#39;ultima revisione valida.



   Se desideri sapere in che data e ora stai ripristinando l&#39;archivio, esegui questo comando nella `segmentstore` cartella (sostituire *afdb922d-ba53-4a1b-aa1b-1cb044b535cf* con l&#39;ultima buona revisione nel tuo `journal.log`):



   `find . -type f -name "data*.tar" -exec sh -c "tar -tvf {} |grep afdb922d-ba53-4a1b-aa1b-1cb044b535cf" \; -print`



   L&#39;output mostrerebbe una data e un&#39;ora approssimative di tale revisione.
5. Rimuovi tutto `./crx-quickstart/repository/segmentstore/*.bak files.`
6. Se utilizzi AEM 6.0, scarica la versione oak-run corrispondente a quella installata in AEM per i passaggi rimanenti.

   Scarica da qui [https://repo1.maven.org/maven2/org/apache/jackrabbit/oak-run/](https://repo1.maven.org/maven2/org/apache/jackrabbit/oak-run/).
7. Esegui <b>pulizia dei checkpoint</b> per rimuovere i checkpoint orfani:

   `java -jar oak-run-*.jar checkpoints ./crx-quickstart/repository/segmentstore rm-unreferenced`


8. Infine, compatta l&#39;archivio:

   `java -jar oak-run-*.jar compact ./crx-quickstart/repository/segmentstore/`




<b>B. Rimuovere manualmente i nodi danneggiati.</b>

In AEM, le impostazioni TarMK senza FileDatastore configurato e le situazioni in cui la corruzione è nei binari, puoi fare quanto segue.

*Attenzione:*La procedura seguente è destinata agli utenti dell&#39;alimentazione.
Quando si eliminano i nodi corrotti è necessario assicurarsi che non siano nodi di sistema (ad esempio `/home`, `/jcr:system`, ecc.) .
Oppure, se si tratta di nodi di sistema, è necessario assicurarsi di poterli ripristinare.
Se non sei sicuro, consulta AEM team di Assistenza clienti per assistenza sui passaggi qui documentati.

1. AEM.
2. Usa la console di esecuzione di Oak e carica il `childCount` script groovy per identificare i nodi corrotti nell&#39;archivio segmenti:

   Carica la shell della console di oak-run:

   `java -jar oak-run-*.jar console crx-quickstart/repository/segmentstore`



   Esegui i due comandi seguenti nella shell per caricare lo script ed eseguirlo:

   `:load`

   `https://gist.githubusercontent.com/stillalex/e7067bcb86c89bef66c8/raw/d7a5a9b839c3bb0ae5840252022f871fd38374d3/childCount.groovy`

   `countNodes(session.workingNode)`



   Questo si traduce nel seguente output che indica il percorso dei nodi danneggiati:

   `21:21:42.029 main ERROR o.a.j.o.p.segment.SegmentTracker - Segment not found: 63ae05a4-b506-445c-baa2-cfa1b13b6e2f. Creation date delta is 3 ms.`

   `warning unable to read node /content/dam/test.txt/jcr:content/renditions/original/jcr:content`



   In alcuni casi il problema è collegato a proprietà binarie e alla `childCount` impossibile individuare nodi danneggiati.

   In questi casi è possibile utilizzare il seguente comando che leggerà i primi 1024 byte per ogni binario rilevato durante l&#39;attraversamento (Nota che questo comando sarà più lento e dovrebbe essere utilizzato solo quando quello sopra non restituisce i risultati previsti):

   `countNodes(session.workingNode,true)`


3. Rimuovi tutti i nodi danneggiati identificati elencati nell&#39;output dell&#39;ultimo comando utilizzando `rmNodes.groovy`.

   Carica la shell della console di oak-run:

   `java -jar oak-run-*.jar console crx-quickstart/repository/segmentstore`



   Carica lo script groovy:

   `:load`

   `https://gist.githubusercontent.com/stillalex/43c49af065e3dd1fd5bf/raw/9e726a59f75b46e7b474f7ac763b0888d5a3f0c3/rmNode.groovy`



   Esegui il `rmNode` comando per rimuovere il nodo corrotto, sostituire `/path/to/corrupt/node` con il percorso del nodo corrotto è necessario rimuovere.

   `rmNode(session, "/path/to/corrupt/node")`



   Dove il percorso del nodo corrotto è il percorso ottenuto al passaggio 2, ad esempio: `/content/dam/test.txt/jcr:content/renditions/original/jcr:content/`.
Nota: Quando utilizzi `oak-run.jar` versione 1.6.13 e successive, set `--read-write` Parametro JVM se si verifica un errore come:




   ```
   / rmNode(session,"/path/to/corrupt/node")Removing node /path/to/corrupt/nodeERROR java.lang.UnsupportedOperationException:Cannot write to read-only storeat org.apache.jackrabbit.oak.segment.SegmentWriterBuilder$1.execute (SegmentWriterBuilder.java:171)at org.apache.jackrabbit.oak.segment.SegmentWriter.writeNode (SegmentWriter.java:318)at org.apache.jackrabbit.oak.segment.SegmentNodeBuilder.getNodeState (SegmentNodeBuilder.java:111)at org.apache.jackrabbit.oak.segment.SegmentNodeStore$Commit.init (SegmentNodeStore.java:581)at org.apache.jackrabbit.oak.segment.SegmentNodeStore.merge (SegmentNodeStore.java:333)at org.apache.jackrabbit.oak.spi.state.NodeStore$merge.call (Unknown Source)at groovysh_evaluate.rmNode (groovysh_evaluate:11)
   ```
4. Ripetere il passaggio 3 per tutti i nodi trovati al passaggio 2.

   Questo qui sopra `rmNode` Il comando deve restituire true per il percorso corrotto, il che significa che lo ha eliminato.

   Assicurati che questi tre percorsi corrotti trovati vengano eliminati eseguendo nuovamente il `rmNode` su questi percorsi.

   Per la prossima esecuzione dovrebbe restituire `false`.



   Se vedi ancora che gli stessi percorsi sono presenti nell&#39;archivio, utilizza la versione patched del jar oak-run (cioè *oak-run-1.2.18-NPR-17596*).



   Cosa fa la versione patched del jar oak-run?

   Questa versione di jar salta i binari illeggibili sulla compattazione, sostituendoli con binari a 0 byte e registrando l&#39;eccezione e il percorso di syserr.

   L&#39;archivio così compatto dovrebbe quindi passare oak-run check, lo script di conteggio dei nodi e dovresti anche essere in grado di compattarlo di nuovo utilizzando un oak-run non patched.


5. Esegui una pulizia dei checkpoint elencando i checkpoint utilizzando di seguito.

   Se sono presenti più punti di controllo, puliscili:



   `nohup java -Xmx4096m -jar oak-run-1.2.18.jar checkpoints /app/AEM6/author/crx-quickstart/repository/segmentstore rm-allnohup.out &`


6. Esegui una compattazione offline.

   Se non sai come eseguire la compattazione offline, vedi [Istruzioni per la compattazione offline di Oak](https://gist.github.com/andrewmkhoury/0b1fe4d8b619178ff87b) su GitHub Gist.


7. Avvia il server e attendi il completamento dell&#39;indicizzazione.

