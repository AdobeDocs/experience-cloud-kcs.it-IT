---
title: Migrare utenti, gruppi e ACL tra istanze AEM
description: Descrizione
solution: Experience Manager
product: Experience Manager
applies-to: Experience Manager
keywords: KCS
resolution: Resolution
internal-notes: 'Helpx Link: https://helpx.adobe.com/experience-manager/kb/migrate-users-groups-ACLs.html ; Contains Docs links that may need to be changed'
bug: false
article-created-by: Gucci Paull
article-created-date: 6/21/2022 6:07:06 PM
article-published-by: Gucci Paull
article-published-date: 6/21/2022 6:07:59 PM
version-number: 8
article-number: KA-16448
dynamics-url: https://adobe-ent.crm.dynamics.com/main.aspx?forceUCI=1&pagetype=entityrecord&etn=knowledgearticle&id=d7ce3bf2-8cf1-ec11-bb3d-6045bd015716
exl-id: 5c285ad4-da35-4ee4-b3d1-3ac9eea5f5b2
source-git-commit: af761579c3fb5e51cf5f4d144bff0e058fd13911
workflow-type: tm+mt
source-wordcount: '960'
ht-degree: 1%

---

# Migrare utenti, gruppi e ACL tra istanze AEM

## Descrizione

Come migrare utenti e gruppi con autorizzazioni ACL in AEM da un server a un altro o da un&#39;istanza AEM a un&#39;altra.

## Risoluzione

**Passaggio 1: Trova l&#39;amministratore e gli utenti anonimi**

1. Vai all’app CRXDE lite `/crx/de/index.jsp` e accedi come utente amministratore (sul sistema di origine).
1. Vai a &quot;Strumenti&quot; = &quot;Query&quot;.
1. Nella casella &quot;Query&quot; in basso, inserisci questa query per trovare l&#39;utente amministratore: *`/jcr:root/home/users//element(\*,rep:User)@rep:principalName="admin" .`*
1. Fai clic su &quot;Esegui&quot; e copia il percorso del nodo utente amministratore nei risultati in un file di testo.
1. Ripeti il passaggio 3 con una query per l&#39;utente anonimo: *`/jcr:root/home/users//element(\*,rep:User)@rep:principalName="anonymous" .`*
1. Fai clic su &quot;Esegui&quot; e copia il percorso del nodo utente anonimo nei risultati in un file di testo (quindi ora hai due percorsi, uno per &quot;admin&quot; e uno per &quot;anonymous&quot;).

   Esempio:

   `/home/users/Q/QY5FIMXeQIbGpwZtQ3Dv` - utente amministratore sul sistema di origine

   `/home/users/K/Kj1406Qo9IDODc_nk5Ib` - utente anonimo sul sistema di origine

**Passaggio 2A: Migrare utenti e gruppi (utilizzando `crx2oak` o `oak-upgrade`)**

Gli utenti e i gruppi possono essere migrati tra AEM istanze utilizzando [crx2oak](https://helpx.adobe.com/experience-manager/6-4/sites/deploying/using/using-crx2oak.html) o [oak-upgrade](https://jackrabbit.apache.org/oak/docs/migration.html) strumenti.

1. Scarica la `crx2oak` o `oak-upgrade` jar corrispondente alla versione Oak in uso: 
   1. Aggiornamento Oak: [https://repo1.maven.org/maven2/org/apache/jackrabbit/oak-upgrade](https://repo1.maven.org/maven2/org/apache/jackrabbit/oak-upgrade)
   1. Crx2Oak: [Archivio Maven](https://mvnrepository.com/artifact/com.adobe.granite/crx2oak?repo=adobe-public)
1. Carica il file jar sul server AEM
1. Interrompi AEM (istanze di origine e di destinazione)
1. Sostituisci il nome del file jar nel comando sottostante.
1. Sostituisci *`/home/users/Q/QY5FIMXeQIbGpwZtQ3Dv,/home/users/K/Kj1406Qo9IDODc_nk5Ib`* in *`--exclude-paths`* parametro di parte del comando sottostante con i percorsi degli utenti amministratori e anonimi dal sistema di origine.
1. Modifica i percorsi in linea in modo che corrispondano alla tua istanza (aggiungi *`segment-old:`* prima del percorso, se necessario, vedi qui [https://jackrabbit.apache.org/oak/docs/migration.html](https://jackrabbit.apache.org/oak/docs/migration.html)): *`/opt/aem-source/crx-quickstart/repository /opt/aem-destination/crx-quickstart/repository`*
1. Esegui quindi il comando sulla shell del server.

   ```
   java -Xms2g -Xmx2g -jar oak-upgrade-1.8.12.jar \
   --include-paths=/home \
   --merge-paths=/home \
   --exclude-paths=/home/users/Q/QY5FIMXeQIbGpwZtQ3Dv,/home/users/K/Kj1406Qo9IDODc_nk5Ib,/home/groups/a/administrators,/home/groups/a/analytics-administrators,/home/groups/c/community-moderators,/home/groups/c/content-authors,/home/groups/c/contributor,/home/groups/community/community-groupadmin,/home/groups/community/community-sitecontentmanager,/home/groups/community/community-sitemembers,/home/groups/d/dam-users,/home/groups/default/order-administrators,/home/groups/e/everyone,/home/groups/f/forms-users,/home/groups/forms/fd-administrators,/home/groups/forms/forms-users,/home/groups/geometrixx,/home/groups/media,/home/groups/o/operators,/home/groups/projects,/home/groups/t/tag-administrators,/home/groups/t/target-activity-authors,/home/groups/u/user-administrators,/home/groups/w/workflow-editors,/home/groups/w/workflow-users,/home/users/a/admin,/home/users/a/anonymous,/home/users/mac,/home/users/media,/home/users/projects,/home/users/system,/home/rep:policy,/home/users/rep:policy,/home/groups/rep:policy \
   segment-old:/opt/aem-source/crx-quickstart/repository /opt/aem-destination/crx-quickstart/repository  upgradeusers.log &
   ```

1. Una volta completato, vai al passaggio 3 per migrare gli ACL.  Se non riesci a eseguire la migrazione utilizzando `crx2oak` segui invece i passaggi di migrazione del pacchetto riportati di seguito.

**Passaggio 2B: migrazione di utenti e gruppi (tramite pacchetti)**

Se gli utenti non vengono importati automaticamente tramite autenticazione LDAP / SAML o `CRX2Oak` (metodo A sopra) puoi creare pacchetti di utenti e gruppi.  In questo caso puoi creare due pacchetti separati sul vecchio sistema (esclusi gli utenti amministratori e anonimi predefiniti).

1. Copia il percorso dei nodi utente anonimi e amministratori dai risultati del passaggio 1 (&quot;Trova gli utenti amministratori e anonimi&quot;) sopra.

   Esempio:

   `/home/users/Q/QY5FIMXeQIbGpwZtQ3Dv` - utente amministratore sul sistema in cui sto creando il pacchetto

   `/home/users/K/Kj1406Qo9IDODc_nk5Ib` - utente anonimo sul sistema in cui sto creando il pacchetto

1. Vai alla &quot;Gestione pacchetti&quot;, *`http://host:port/crx/packmgr/index.jsp`* e accedi come amministratore.
1. Crea pacchetto &quot;utenti&quot;
1. Aggiungi un filtro alla configurazione del pacchetto per `/home/users` con queste regole di esclusione (sul `/home/users` filtro):
   1. `exclude /home/users/.\*/.tokens`
   1. `exclude /home/users/Q/QY5FIMXeQIbGpwZtQ3Dv`
   1. `exclude /home/users/K/Kj1406Qo9IDODc_nk5Ib`
   1. `exclude /home/users/a/admin`
   1. `exclude /home/users/a/anonymous`
   1. `exclude /home/users/system`
   1. `exclude /home/users/geometrixx`
   1. `exclude /home/users/media`
   1. `exclude /home/users/projects`
   1. `exclude /home/users/mac`
1. Crea il pacchetto.
1. Scarica il pacchetto.
1. Decomprimi il file zip del pacchetto sul computer: `jar -xvf users.zip META-INF/vault/filter.xml`
1. Apri il file . `META-INF/vault/filter.xml` in un editor di testo.
1. Aggiungi `mode="merge"` al tag filtro ..., ad esempio:

   ```
   ?xml version="1.0" encoding="UTF-8"?    workspaceFilter version="1.0"    filter root="/home/users" mode="merge"    exclude pattern="/home/users/.*/.tokens"/    exclude pattern="/home/users/Q/QY5FIMXeQIbGpwZtQ3Dv"/    exclude pattern="/home/users/K/Kj1406Qo9IDODc_nk5Ib"/    exclude pattern="/home/users/a/admin"/    exclude pattern="/home/users/a/anonymous"/    exclude pattern="/home/users/system"/    exclude pattern="/home/users/geometrixx"/    exclude pattern="/home/users/media"/    exclude pattern="/home/users/projects"/    exclude pattern="/home/users/mac"/    /filter    /workspaceFilter
   ```

1. Ricomprimi il contenuto del pacchetto modificato in modo che includa la modifica.

   ```
   jar -uvf users.zip META-INF/vault/filter.xml
   ```

1. Crea un pacchetto &quot;gruppi&quot; che contiene una regola di filtro `/home/groups`.
1. Ripetere i passaggi 11-14 per il pacchetto gruppi.
1. (Solo aggiornamento) Se esegui la migrazione alla versione più recente AEM, installa una nuova istanza AEM locale *della vecchia versione*(con nosamplecontent), e installa il pacchetto utenti e poi il pacchetto gruppi lì. Quindi, esegui un aggiornamento locale alla nuova versione in tale istanza. In questo modo gli utenti vengono convertiti nella nuova rappresentazione Oak. Dopo l&#39;aggiornamento in-place, crea di nuovo un pacchetto con gli utenti per portarli nuovamente nell&#39;istanza aggiornata prevista. Effettua le stesse operazioni per i gruppi di utenti.
1. Installa il pacchetto utenti sul nuovo sistema.
1. Installa il pacchetto gruppi sul nuovo sistema.
1. Se effettui la migrazione da una versione precedente di AEM alla versione 6.3, passa alla `/useradmin` Interfaccia utente e aggiungi il ricevitore di replica utente al gruppo &quot;amministratori&quot;.

**Passaggio 3: Esegui migrazione ACL**

Se sei in grado di installare strumenti (ACS Commons) da AEM, segui questi passaggi:

1. Scarica e installa ACS Commons.
1. Segui i passaggi forniti qui per creare un pacchetto ACL.
1. Vai su http://aem-host:port/crx/packmgr/index.jsp and accedi come amministratore.
1. Fai clic sul pacchetto ACL.
1. Fai clic su Modifica.
1. Seleziona la [!UICONTROL Avanzate] scheda (vedi schermata sottostante).
1. Nel menu a discesa Gestione AC, seleziona [!UICONTROL Unisci] per evitare di rimuovere le ACL esistenti sul sistema di destinazione. Questo è particolarmente importante quando si migrano ACL tra diverse versioni di AEM (in quanto evita di rimuovere ACL preconfigurati).

Se sei *not* in grado di installare strumenti (ACS Commons) per AEM, quindi segui questi passaggi. Il computer in cui vengono eseguiti questi comandi deve essere Mac OS, [!DNL Linux]oppure [!DNL Windows] (utilizzando [!DNL Cygwin]) con cURL, [!DNL Python]e [!DNL Java] SDK installato.

1. Vai su http://src-aem-host:port/crx/packmgr/index.jsp and accedi come amministratore.
1. Crea un pacchetto chiamato &quot;ACL-migration&quot;
1. Fare clic sul pulsante Modifica.
1. Seleziona la [!UICONTROL Avanzate] e impostare la modalità AC Handling su Merge.
1. Salva.
1. Crea il pacchetto e scaricalo.
1. Sul file system esegui questo comando sul pacchetto per estrarre il `META-INF/vault/filter.xml` file: 

   ```
   jar -xvf ACL-migration-1.0.zip META-INF/vault/filter.xml
   ```

1. Nella stessa directory, esegui questo comando per scaricare un file json dei percorsi ACL sotto `/content` dall&#39;istanza sorgente (imposta il nome utente e la password e l&#39;host corretto): 

   ```
   curl -u admin:admin 'http://aemhost/crx/de/query.jsp?' -G --data-urlencode '_dc=1507011481908&_charset_=utf-8&type=xpath&stmt=/jcr:root/content//element(*,rep:ACL)&showResults=true'  data.json
   ```

1. Creare un file `generate-package-filter.py` e incolla [!DNL Python] codice al suo interno: 

   ```
   import json
   from pprint import pprint
   
   with open ('data.json') as data_file:
      data = json.load(data_file)
   
   print("?xml version=\"1.0\" encoding=\"UTF-8\"?")
   print("workspaceFilter version=\"1.0\"")
   
   for item in data "results":
       print("filter root=\"{path}\" /" . format(path=item "path"))
   
   print( "/workspaceFilter")
   ```

1. Esegui il [!DNL Python] script dalla stessa cartella in cui è stato creato data.json e salva l’output in `META-INF/vault/filter.xml` (sostituzione del contenuto esistente di `filter.xml`): 

   ```
   python generate-packge-filter.py  META-INF/vault/filter.xml
   ```

1. Usa questo comando per aggiornare il `filter.xml` nel file zip:

   ```
   jar -uvf ACL-migration-1.0.zip META-INF/vault/filter.xml
   ```

1. Carica il file zip nel gestore dei pacchetti dell&#39;istanza sorgente: http://src-aem-host:port/crx/packmgr/index.jsp
1. Fai clic su [!UICONTROL Crea] o [!UICONTROL Ricostruire] per creare il pacchetto.
1. Scarica il pacchetto dal server AEM di origine.
1. Carica il pacchetto nel gestore dei pacchetti AEM server di destinazione: http://dst-aem-host:port/crx/packmgr/index.jsp
1. Fai clic su [!UICONTROL Installa] per installarlo.
1. Ripeti i passaggi 8-16 per tutti gli altri percorsi che modificano il comando curl del percorso. Ad esempio, questo otterrebbe gli ACL sotto `/etc` anziché `/content`:

   ```
   curl -u admin:admin 'http://aemhost/crx/de/query.jsp?' -G --data-urlencode '_dc=1507011481908&_charset_=utf-8&type=xpath&stmt=/jcr:root/etc//element(*,rep:ACL)&showResults=true'  data.json` |
   ```
